<%@ page language="java" contentType="text/html; charset=ISO-8859-1"
	pageEncoding="ISO-8859-1"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<jsp:include page='_Header_Gentellela.jsp'>
	<jsp:param name="title" value="Parameter Funding" />
	<jsp:param name="datatables" value="1" />
	<jsp:param name="jqueryconfirm" value="1" />
	<jsp:param name="jquerydatepicker" value="1" />
	<jsp:param name="noityjs" value="1" />
</jsp:include>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">

			<jsp:include page='_Side_Navigation.jsp' />
			<jsp:include page='_Top_Navigation.jsp' />


			<div class="right_col" role="main">
				<div class="row">
					<div class="col-xs-12 col-sm-12 col-lg-12">
						<div class="x_panel">
							<div class="x_title">
								<h2 id="breadhead"></h2>
								<script type="text/javascript">
									var context = "${local_server}";
									document.getElementById("breadhead").innerHTML = getBread(encodeURI(String(
											window.location.href)
											.split(context)[1]));
								</script>

								<ul class="nav navbar-right panel_toolbox">

								</ul>
								<div class="clearfix"></div>
							</div>
							<div class="x_content">

								<form id="formInput">
									<table width="100%" class="table table-bordered">
										<tr>
											<td colspan="5"><h5>KiniDanaku</h5>
												<div id="msg1"></div>
												<input type="hidden" id="pkd_id" name="pkd_id"></td>
										</tr>
										<tr>
											<td>Minimum Investasi</td>
											<td>
												<div class="input-group">
													<span class="input-group-addon" id="basic-addon1">Rp</span>
													<input type="text" id="pkd_min_invest" name="min_invest"
														class="form-control" required="required">
												</div>


											</td>

											<td>Tax</td>
											<td><div class="input-group"><input type="number" step=".01" min=0 max=100 id="pkd_tax" name="tax"
												required="required" class="form-control prmpct">
												<span class="input-group-addon" id="basic-addon1">%</span>
												</div></td>
										</tr>
										<tr>
											<td>Maximum Investasi Per Aplikasi</td>
											<td><div class="input-group"><input type="number" step=".01" min=0 max=100 id="pkd_max_inv_pctn"
												required="required" name="max_inv_pct" class="form-control numeric"><span class="input-group-addon" id="basic-addon1">%</span>
												</div></td>

											<td>Booking Valid (in Jam)</td>
											<td>
												<div class="input-group">

													<input type="text" id="pkd_booking_valid"
														required="required" name="booking_valid"
														class="form-control numeric"> <span
														class="input-group-addon" id="basic-addon1">HHmm</span>
												</div>
											</td>
										</tr>
										<tr>
											<td>Multiple Investasi</td>
											<td><input type="text" id="pkd_multiple_invest"
												required="required" name="multiple_invest"
												class="form-control numeric"></td>
											<td>&nbsp;</td>
											<td>&nbsp;</td>

										</tr>
										<tr>
											<td colspan="5"><h5>Komisi</h5>
												<div id="msgkomisi"></div> <input type="hidden" name="pkomisi_id"
												id="pkomisi_id"></td>
										</tr>
										<tr>
											<td colspan="5">
												<table width="100%" id="tabledetparam">
													<thead>
														<tr>
															<td width="50%">Type</td>
															<td width="10%">Komisi Investasi (%)</td>
															<td width="10%">Komisi Repayment (%)</td>
															<td width="10%">Komisi Late Payment (%)</td>
															<td width="10%">Komisi Collection (%)</td>
															<td width="10%">Action</td>
														</tr>
													</thead>
													<tfoot>
														<tr>
															<td>
																<select class="form-control selectpicker" name="selType" id="selType"></select>
															</td>
															<td>
																<div class="form-group" style="margin-bottom:0">
																	<input onkeypress="return isNumberKey(event)" class="form-control" type="text" id="txtKomisiInvestasi" />
																</div>
															</td>
															<td>
																<div class="form-group" style="margin-bottom:0">
																	<input onkeypress="return isNumberKey(event)" class="form-control" type="text" id="txtKomisiRepayment" />
																</div>
															</td>
															<td>
																<div class="form-group" style="margin-bottom:0">
																	<input onkeypress="return isNumberKey(event)" class="form-control" type="text" id="txtKomisiLate" />
																</div>
															</td>															
															<td>
																<div class="form-group" style="margin-bottom:0">
																	<input onkeypress="return isNumberKey(event)" class="form-control" type="text" id="txtKomisiCollection" />
																</div>
															</td>
															<td style="vertical-align:middle">
																<button type="button" class="addnew btn btn-xs btn-success" id="btnAdd">Add</button>															
															</td>															
														</tr>
													</tfoot>
												</table>
											</td>
										</tr>
										
										<tr>
											<td colspan="5"><h5>Wallet</h5>
												<div id="msg2"></div> <input type="hidden" name="pwt_id"
												id="pwt_id"></td>
										</tr>
										<tr>
											<td>Minimum Topup</td>
											<td>
											<div class="input-group">
													<span class="input-group-addon" id="basic-addon1">Rp</span>
											<input type="text" id="pwt_min_topup"
												required="required" name="min_topup" class="form-control"></div></td>

											<td>Minimum Withdraw</td>
											<td><div class="input-group">
													<span class="input-group-addon" id="basic-addon1">Rp</span><input type="text" id="pwt_min_withdraw"
												required="required" name="min_withdraw" class="form-control"></div></td>
										</tr>
										<tr>
											<td>Cost Topup</td>
											<td><div class="input-group">
													<span class="input-group-addon" id="basic-addon1">Rp</span><input type="text" id="pwt_cost_topup"
												required="required" name="cost_topup" class="form-control"></div></td>

											<td>Cost Withdraw</td>
											<td><div class="input-group">
													<span class="input-group-addon" id="basic-addon1">Rp</span><input type="text" id="pwt_cost_withdraw"
												required="required" name="cost_withdraw"
												class="form-control"></div>
												
											</td>
										</tr>
										<tr>
											<td>Deposit Valid</td>
											<td><div class="input-group"><input type="text" id="pwt_deposit_valid"
												required="required" name="validity" class="form-control numeric">
												
												<span class="input-group-addon" id="basic-addon1">Hour</span>
												</div></td>

											<td>Estimasi Withdraw</td>
											<td><div class="input-group"><input type="text" id="pwt_est_withdraw"
												required="required" name="est_withdraw" class="form-control numeric">
												<span class="input-group-addon" id="basic-addon1">Days</span>
												</div></td>
										</tr>
									</table>
									<hr>
									<div class="row">
										<div class="simplebox" align="right">
											<button type="submit" id="btnSave"
												class="btn btn-primary btn-lg">Save</button>

										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<jsp:include page='_Footer_Note.jsp'></jsp:include>
	</div>
</body>

<jsp:include page='_Footer_Gentellela.jsp'>
	<jsp:param name="title" value="Disbursement" />
	<jsp:param name="datatables" value="1" />
	<jsp:param name="jqueryconfirm" value="1" />
	<jsp:param name="jquerydatepicker" value="1" />
	<jsp:param name="inputmask" value="1" />
	<jsp:param name="noityjs" value="1" />
</jsp:include>

<script>
function getDDLType() {
	$.get("${local_server}/parameter_funding/list_type", function(data) {
		var x = JSON.parse(data);
		console.log(x);
		var ht = "";
		$.each(x.data, function(i, o) {
			ht += "<option value='"+o.pcs_type+"'>" + o.pcs_type_name + "</option>";
		});

		$("#selType").empty().append(ht);
	});
}

function getListKomisi(id){
	/*$.get("${local_server}/parameter_funding/list_komisi/"+id, function(dt) {
		var x = JSON.parse(dt);
		console.log(x);*/
		$('#tabledetparam').DataTable().destroy();
		
		var tbl = $('#tabledetparam')
			.DataTable({
				ajax : {
					url : '${local_server}/parameter_funding/list_komisi/'+id,
				},
				ordering: false,
				paging: false,
				bInfo: false,
				searching: false,
				columns: [
					{
						render: function(data,type,row,meta){
							return row.pcs_type_name+'<input type="hidden" name="pcs_type" value="'+row.pcs_type+'" /><input type="hidden" name="pcs_type_name" value="'+row.pcs_type_name+'" />';
						}
					},
					{
						render: function(data,type,row,meta){
							var txt = '';
							
							txt = '<input class="form-control" type="text" name="pcs_invest" id="'+meta.row+'_invest" value="'+row.pcs_invest+'"/>';
							
							return txt;
						}
					},
					{
						render: function(data,type,row,meta){
							var txt = '';
							
							txt = '<input class="form-control" type="text" name="pcs_repay" id="'+meta.row+'_repay" value="'+row.pcs_repay+'" />';
							
							return txt;
						}
					},
					{
						render: function(data,type,row,meta){
							var txt = '';
							
							txt = '<input class="form-control" type="text" name="pcs_late" id="'+meta.row+'_late" value="'+row.pcs_late+'" />';
							
							return txt;
						}
					},					
					{
						render: function(data,type,row,meta){
							var txt = '';
							
							txt = '<input class="form-control" type="text" name="pcs_collect" id="'+meta.row+'_repay" value="'+row.pcs_collect+'" />';
							
							return txt;
						}
					},
					{
						render : function(data,type,row, meta) {
							var txt = '';
							txt += '<button class="btn btn-xs btn-danger" onclick="$(\'#tabledetparam\').DataTable().row( $(this).parents(\'tr\') ).remove().draw();">Delete</button>';
							/*
							txt = '<button class="edit btn btn-xs btn-success" id="'+row.ddp_id+'" value="'+row.ddl_value+'">Update'
									+ '</button>';
							txt += ' | ';
							
							txt += '<button class="u btn btn-xs btn-primary" id="'+row.ddp_id+'_u" name="'+row.ddp_isused+'" value="'+row.ddl_value+'">';
							if(row.ddp_isused){ txt += 'Used'; }else{ txt += 'Not Used';  }
							txt += '</button>';
							*/
							return txt;
						}
					}
				]
			});		
	//});
}

function chkType(t){
	var txtseltype = document.getElementsByName('pcs_type');
	var j = 0;
	if(txtseltype.length > 0){
		for(i=0;i<txtseltype.length;i++){
			if(t == txtseltype[i].value){
				j++;
			}
		}
	}
	if(j>0){return false;}else return true;
}

	$(document)
			.ready(
					function() {
						getDDLType();
						getListKomisi(1);
						
						$("#btnAdd").on("click",function() {
							if(document.getElementById('selType').value != ""){
								if(chkType(document.getElementById('selType').value)){
									$('#tabledetparam').DataTable().row.add({
										"pcs_type" : document.getElementById('selType').value,
										"pcs_type_name" : document.getElementById('selType').options[document.getElementById('selType').selectedIndex].text,
										"pcs_invest" : document.getElementById('txtKomisiInvestasi').value,
										"pcs_repay" : document.getElementById('txtKomisiRepayment').value,
										"pcs_late" : document.getElementById('txtKomisiLate').value,
										"pcs_collect" : document.getElementById('txtKomisiCollection').value
									}).draw(false);
									
									document.getElementById('txtKomisiInvestasi').value = "";
									document.getElementById('txtKomisiRepayment').value = "";
									document.getElementById('txtKomisiLate').value = "";
									document.getElementById('txtKomisiCollection').value = "";
								}else{
									alert('Type yang dipilih sudah digunakan di atas.');
									return false;
								}
							}else{
								alert('Type tidak boleh kosong.');
								return false;
							}
						});
						
						dki_val_char();
								$(
										"#pkd_min_invest, #pwt_min_topup, #pwt_min_withdraw, #pwt_cost_topup, #pwt_cost_withdraw")
										.inputmask("numeric", {
											radixPoint : ".",
											groupSeparator : ",",
											digits : 2,
											autoGroup : !0,
											prefix : "",
											rightAlign : !0,
											oncleared : function() {
											}
										}),
										
										$(".numeric")
										.inputmask("numeric", {
											radixPoint : "",
											groupSeparator : "",
											digits : 2,
											autoGroup : !0,
											prefix : "",
											rightAlign : !0,
											oncleared : function() {
											}
										}),$(".prmpct")
										.inputmask("numeric", {
											radixPoint : ".",
											groupSeparator : "",
											digits : 2,
											autoGroup : !0,
											prefix : "",
											rightAlign : !0,
											oncleared : function() {
											}
										});
								$("#formInput")
										.submit(
												function(e) {
													$
															.confirm({
																title : 'Confirm',
																content : 'Are you sure want to save changes ?',
																buttons : {
																	cancel : function() {
																		$
																				.alert('Canceled!');
																	},
																	somethingElse : {
																		text : 'Save',
																		btnClass : 'btn-blue',
																		keys : [
																				'enter',
																				'shift' ],
																		action : function() {
																			sumbitFrm();
																		}
																	}
																}
															});
													e.preventDefault();
												});
						getKiniDanakuDet();
						getKiniDanakuWalletDet();
					});

	function toRp(e) {
		if ("null" == e)
			return 0;
		for (var t = parseInt(e, 10).toString().split("").reverse().join(""), n = "", a = 0; a < t.length; a++)
			n += t[a], (a + 1) % 3 === 0 && a !== t.length - 1 && (n += ",");
		return "" + n.split("").reverse().join("")
	}

	function sumbitFrm() {
		$.ajax({
			type : "POST",
			url : "${local_server}/parameter_funding/dopost",
			data : $("#formInput").serialize(),
			cache : !1,
			beforeSend : function() {
				$('button[type=submit]').prop('disabled', true);
			},
			complete : function(e, t) {
				$('button[type=submit]').prop('disabled', false);
				if ("error" !== t && e.responseText) {

					var n = JSON.parse(e.responseText);
					if (n.status == "Success") {
						$.confirm({
							title : "",
							content : n.msg,
							buttons : {
								somethingElse : {
									text : "OK",
									btnClass : "btn-success",
									keys : [ "enter" ],
									action : function() {
										getKiniDanakuDet();
										getKiniDanakuWalletDet();
									}
								}
							}
						});
					} else {
						$.alert("Failed to Save");
					}
				}
			}
		});
	}

	function getKiniDanakuDet() {
		$
				.ajax({
					type : "GET",
					url : "${local_server}/parameter_funding/kdk_param_detail/${pkd_id}",
					dataType : "json",
					async : true,
					beforeSend : function() {
						$("#msg1")
								.html(
										"<span class='label label-default'><i class='fa fa-circle-o-notch fa-spin'></i> Loading Parameter ...</span>");
					},
					success : function(res) {
						$("#msg1").html("");
						console.log(res);
						$.each(res.data[0], function(i, o) {
							//o = (i == "pkd_min_invest")?toRp(o):o;
							$("#" + i).val(o);
						});
					}
				});
	}
	
	function dki_val_char(){
		/* $(".prmpct").on("keypress", function(event) {
	            var AlphabetWhiteSpace = /[A-Za-z0-9.]/g;
	            var key = String.fromCharCode(event.which);
	          	console.log(event.keyCode)
	            if (event.keyCode == 8 || AlphabetWhiteSpace.test(key)) {
	                return true;
	            }
	            return false;
	    }); */
		
		
	}

	function getKiniDanakuWalletDet() {
		$
				.ajax({
					type : "GET",
					url : "${local_server}/parameter_funding/kdk_param_wallet/${pkd_id}",
					dataType : "json",
					async : true,
					beforeSend : function() {
						$("#msg2")
								.html(
										"<span class='label label-default'><i class='fa fa-circle-o-notch  fa-spin'></i> Loading Parameter ...</span>");
					},
					success : function(res) {
						$("#msg2").html("");
						if (Object.keys(res.data).length > 0) {
							$.each(res.data[0], function(i, o) {
								o = (i == "pwt_min_topup") ? toRp(o) : o;
								o = (i == "pwt_min_withdraw") ? toRp(o) : o;
								o = (i == "pwt_cost_withdraw") ? toRp(o) : o;
								o = (i == "pwt_cost_topup") ? toRp(o) : o;
								$("#" + i).val(o);
							});
						} else {
							$("#pwt_id").val(0);
						}
					}
				});
	}
</script>